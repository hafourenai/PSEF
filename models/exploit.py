from dataclasses import dataclass, field
from typing import Dict, Any, Optional, List
from datetime import datetime
from models.finding import ScannerFinding
from models.enums import ExploitationStatus, ExploitationTechnique

@dataclass
class ExploitationAttempt:
    """Individual exploitation attempt details"""
    payload: str
    technique: Optional[ExploitationTechnique] = None
    success: bool = False
    response_time: float = 0.0
    status_code: Optional[int] = None
    timestamp: datetime = field(default_factory=datetime.now)
    evidence: Dict[str, Any] = field(default_factory=dict)

@dataclass
class VerificationProof:
    """Proof of successful verification"""
    primary_signal: str
    secondary_signal: Optional[str] = None
    reproducible: bool = True
    metadata: Dict[str, Any] = field(default_factory=dict)

@dataclass
class ExploitationResult:
    """Final result of an exploitation process"""
    finding: ScannerFinding
    status: ExploitationStatus
    impact: str = "Unknown"
    verified_proof: Optional[VerificationProof] = None
    extracted_data: Optional[Dict[str, Any]] = None
    metadata: Dict[str, Any] = field(default_factory=dict)
    attempts: List[ExploitationAttempt] = field(default_factory=list)
    evidence: Dict[str, Any] = field(default_factory=dict) # Alias or extra evidence for reporting

    def add_attempt(self, attempt: ExploitationAttempt):
        self.attempts.append(attempt)
        if attempt.success:
            self.status = ExploitationStatus.VERIFIED
